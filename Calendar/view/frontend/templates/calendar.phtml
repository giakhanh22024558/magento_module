<h1>This is where calendar shown!</h1>
<?php
/** @var \Uet\Calendar\Block\Occasions $block */
$occasions = $block->getOccasions();
$categories = $block->getCategories();
$customer_id = $block->getCustomerId();
?>
<h1>Occasions</h1>
<ul id="custom-section-container" 
    data-destroy-url="<?= $block->getUrl('calendar/action/destroy') ?>"
    data-form-key="<?= $block->getFormKey() ?>"
>
</ul>

<form id="occasion-form" action="<?= $block->getUrl('calendar/action/save') ?>" method="post">
    <input type="hidden" id="form_key" name="form_key" value="<?= $block->getFormKey() ?>">
    <input id="occasion-id" type="hidden" name="id">
    <input id="customer-id" type="hidden" name="customer_id" value="<?= $customer_id ?>">
    <div>
        <label for="name">Occasion:</label>
        <select name="occasion" id="occasion" required>
            <?php foreach ($categories as $category): ?>
                <option value="<?= $category['name'] ?>"><?= $category['name'] ?></option>
            <?php endforeach; ?>
        </select>
    </div>
    <div>
        <label for="date">Date:</label>
        <input type="date" name="date" id="date" required>
    </div>
    <div>
        <label for="note">Note:</label>
        <input type="text" name="note" id="note" required>
    </div>
    <div>
        <button type="submit">Save Occasion</button>
    </div>
</form>
<div id="occasion-message"></div>

<script type="text/javascript">

    
    require(['Magento_Customer/js/customer-data', 'domReady!'], function (customerData) {
        var customSection = customerData.get('custom_section');
        //ustomerData.reload(['custom_section'], true);  
        customSection.subscribe(function (data) {
            //console.log(data);
            var container = document.getElementById('custom-section-container');
            var destroyUrl = container.getAttribute('data-destroy-url');
            var formKey = document.getElementById('form_key').value;
            if (container) {
                container.innerHTML = ''; // Clear existing content
                data.occasions.forEach(function (occasion) {
                    var li = document.createElement('li');
                    li.innerHTML = occasion.occasion + ' - ' + occasion.date + '<br>' +
                        (occasion.note ? occasion.note : 'No additional notes available.') +
                        '<form action="' + destroyUrl + '" method="post" style="display:inline;">' +
                        '<input type="hidden" name="form_key" value="' + formKey + '">' +
                        '<input type="hidden" name="id" value="' + occasion.id + '">' +
                        '<button type="submit" onclick="return confirm(\'Are you sure you want to delete this occasion?\');">Delete</button>' +
                        '</form>' +
                        '<button type="button" onclick="populateForm(\'' + occasion.id + '\', \'' + occasion.occasion + '\', \'' + occasion.date + '\', \'' + occasion.note + '\')">Update</button>';
                    container.appendChild(li);
                });
            }
        });
    });

    function populateForm(id, occasion, date, note) {
        var selectElement = document.getElementById('occasion');
        console.log(id + ' - ' + occasion + ' - ' + date + ' - ' + note);
        document.getElementById('occasion-id').value = id;
        for (var i = 0; i < selectElement.options.length; i++) {
            if (selectElement.options[i].value === occasion) {
            // Set the matched option as selected
            selectElement.selectedIndex = i;
            break;
            }
        }
        document.getElementById('date').value = date;
        document.getElementById('note').value = note;
    }


</script>
